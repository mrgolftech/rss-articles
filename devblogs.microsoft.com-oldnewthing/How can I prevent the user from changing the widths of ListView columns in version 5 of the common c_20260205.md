# How can I prevent the user from changing the widths of ListView columns in version 5 of the common controls?

**来源:** [devblogs.microsoft.com/oldnewthing](https://devblogs.microsoft.com/oldnewthing)
**发布时间:** Thu, 05 Feb 2026 15:00:00 +0000
**链接:** https://devblogs.microsoft.com/oldnewthing/20260205-00/?p=112042

---

{'type': 'text/html', 'language': None, 'base': 'https://devblogs.microsoft.com/oldnewthing/feed', 'value': '<p>Last time, we saw how to <a href="https://devblogs.microsoft.com/oldnewthing/20260204-00/?p=112037" title="How can I prevent the user from changing the widths of ListView columns?"> prevent the user from changing the widths of ListView columns</a>, but the technique required version 6 of the common controls. What if you&#8217;re stuck in the dark ages and have to use version 5?</p>\n<p>You can deny the ability to change the width of a header item by listening for <code>HDN_ITEM\xadCHANGING</code> and returning 1 to deny the change if there is a change to the width.</p>\n<pre>case WM_NOTIFY:\n    {\n        auto hdr = (NMHDR*)lParam;\n        if (hdr-&gt;code == HDN_ITEMCHANGING) {\n            auto header = (NMHEADER*)lParam;\n            if (header-&gt;pitem-&gt;mask &amp; HDI_WIDTH) {\n                return 1;\n            }\n        }\n    }\n    return 0;\n</pre>\n<p>The above code assumes that it is running in a window procedure. If it&#8217;s running in a dialog procedure, then you need to set the dialog message result.</p>\n<pre>case WM_NOTIFY:\n    {\n        auto hdr = (NMHDR*)lParam;\n        if (hdr-&gt;code == HDN_ITEMCHANGING) {\n            auto header = (NMHEADER*)lParam;\n            if (header-&gt;pitem-&gt;mask &amp; HDI_WIDTH) {\n                <span style="border-bottom: none;">SetWindowLongPtr(hDlg, DWLP_MSGRESULT, 1);</span>\n                <span style="border-top: none;">return TRUE;                              </span>\n            }\n        }\n    }\n    return FALSE;\n</pre>\n<p>Note that if somebody tries to change both the width and the text, this will reject the entire change. There is, unfortunately, no way to selectively reject the change: Modifications to <code>header-&gt;pitem-&gt;mask</code> are ignored.¹</p>\n<p>However, all is not lost. Even though changes to the mask are ignored, changes to the <code>pitem-&gt;cxy</code> are still honored, so we can just set the width back to whatever the width is right now.</p>\n<pre>case WM_NOTIFY:\n    {\n        auto hdr = (NMHDR*)lParam;\n        if (hdr-&gt;code == HDN_ITEMCHANGING) {\n            auto header = (NMHEADER*)lParam;\n            if (header-&gt;pitem-&gt;mask &amp; HDI_WIDTH) {\n                <span style="border-bottom: none;">HDITEM item;                                             </span>\n                <span style="border-style: none solid;">item.mask = HDI_WIDTH;                                   </span>\n                <span style="border-style: none solid;">if (Header_GetItem(nm-&gt;hdr.hwndFrom, nm-&gt;iItem, &amp;item)) {</span>\n                <span style="border-style: none solid;">{                                                        </span>\n                <span style="border-style: none solid;">    header-&gt;pitem-&gt;cxy = item.cxy;                       </span>\n                <span style="border-top: none;">}                                                        </span>\n            }\n        }\n    }\n    return 0;\n</pre>\n<p>One thing we haven&#8217;t fixed, though, is that the mouse cursor changes to a resize cursor when it is on the border between two column headers, even though resizing has been disabled. We&#8217;ll try to fix that next time.</p>\n<p>¹ This is arguably a bug in the version 5 header control, but there&#8217;s no point trying to fix it now. There may be code that relies on the fact that changes to the mask have no effect, and besides, this is the old and busted version 5 control.²</p>\n<p>² The version 6 control has the same bug, but again, there&#8217;s no point trying to fix it now because it will almost certainly break someone. The version 6 common controls are 25 years old, and it&#8217;s probably safe to assume that every possible change will probably break <i>someone</i>.³</p>\n<p>³ Once, I helped fixed a memory leak in the common controls, but we had to back it out because it broke a major application. We couldn&#8217;t figure out why it broke the program, so we couldn&#8217;t put together a shim. We just had to restore the leak. My guess is that the developers of the program had discovered the leak on their own and was somehow working around it, and our fix broke their workaround.</p>\n<p>The post <a href="https://devblogs.microsoft.com/oldnewthing/20260205-00/?p=112042">How can I prevent the user from changing the widths of ListView columns in version 5 of the common controls?</a> appeared first on <a href="https://devblogs.microsoft.com/oldnewthing">The Old New Thing</a>.</p>'}

---

*抓取时间: 2026-02-06 06:02:30*
