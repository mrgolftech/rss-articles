# Customizing the ways the dialog manager dismisses itself: Isolating the Close pathway

**来源:** [devblogs.microsoft.com/oldnewthing](https://devblogs.microsoft.com/oldnewthing)
**发布时间:** Tue, 24 Feb 2026 15:00:00 +0000
**链接:** https://devblogs.microsoft.com/oldnewthing/20260224-00/?p=112082

---

{'type': 'text/html', 'language': None, 'base': 'https://devblogs.microsoft.com/oldnewthing/feed', 'value': '<p>We started by <a href="https://devblogs.microsoft.com/oldnewthing/20260219-00/?p=112072" title="Exploring the signals the dialog manager uses for dismissing a dialog"> exploring the signals the dialog manager uses for dismissing a dialog</a>. Now we can use that information to customize the dismiss behavior.</p>\n<p>Let&#8217;s start with a diagram, because people like diagrams.</p>\n<table border="0" cellpadding="3" cellspacing="0" class="cp3" style="border-collapse: separate; text-align: center;">\n<tbody>\n<tr>\n<td>&nbsp;</td>\n<td>&nbsp;</td>\n<td><tt>WM_SYS\xadCOMMAND</tt>/<br />\n<tt>SC_CLOSE</tt></td>\n<td>←</td>\n<td style="border-radius: 1ex;">Close button/<br />\n<kbd>Alt</kbd>+<kbd>F4</kbd>/<br />\nSystem menu Close</td>\n</tr>\n<tr>\n<td>&nbsp;</td>\n<td>&nbsp;</td>\n<td>↓</td>\n</tr>\n<tr>\n<td>&nbsp;</td>\n<td>&nbsp;</td>\n<td><tt>WM_CLOSE</tt></td>\n<td>&nbsp;</td>\n<td style="border-radius: 1ex;">User hits <kbd>ESC</kbd></td>\n</tr>\n<tr>\n<td>&nbsp;</td>\n<td>&nbsp;</td>\n<td>↓</td>\n<td>&nbsp;</td>\n<td>↓</td>\n</tr>\n<tr>\n<td style="border-radius: 1ex;">User clicks<br />\nCancel button</td>\n<td>→</td>\n<td><tt>WM_COMMAND</tt>/<br />\n<tt>BN_CLICK</tt>/<br />\n<tt>IDCANCEL</tt></td>\n<td>←</td>\n<td><tt>Is\xadDialog\xadMessage</tt></td>\n</tr>\n</tbody>\n</table>\n<p>We noted at the end of that article that if you have a button whose ID is <code>IDCANCEL</code>, the dialog manager will defer to that button to decide whether to allow <kbd>ESC</kbd> key, the Close button, or other nonclient affordances to convert the corresponding action to a simulated click on that button. So the obvious way to take advantage of this is to put a Cancel button on your dialog box, and disable it when you don&#8217;t want the user to dismiss the dialog box with the <code>ESC</code> key, the Close button, or other standard affordances.¹</p>\n<p>Notice that everything in the diagram funnels into <code>WM_COMMAND</code>/<code>IDCANCEL</code>, even if you don&#8217;t actually have a control whose ID is <code>IDCANCEL</code>. If you add a handler to your dialog procedure for <code>WM_COMMAND</code>, then all of the actions will come through that handler, and you can customize the behavior at that point. You could call <code>EndDialog</code> to close the dialog or just return without doing anything to keep the dialog open.</p>\n<p>Now, if you have no intention of closing the dialog in response to the Close button or the system menu Close command, then you probably shouldn&#8217;t leave them enabled. You can gray those out by doing</p>\n<pre>    EnableMenuItem(GetSystemMenu(hDlg, FALSE), SC_CLOSE,\n                   MF_BYCOMMAND | MF_DISABLED | MF_GRAYED);\n</pre>\n<p>Okay, but what if you want to treat the Close button differently?</p>\n<p>From the diagram, we see that the Close button goes through a <code>WM_CLOSE</code> phase, so you can handle the <code>WM_CLOSE</code> message in your dialog procedure to do whatever custom Close button behavior you want. If you return <code>TRUE</code> from the dialog procedure, then that will mark the message as handled, and further processing will stop. if you return <code>FALSE</code>, then the <code>Def\xadDlg\xadProc</code> will turn the <code>WM_CLOSE</code> into the <code>WM_COMMAND</code> message as before.</p>\n<p>If you want to treat the <kbd>ESC</kbd> key differently from a click on the Cancel button, you&#8217;ll have to intercept it on the <code>Is\xadDialog\xadMessage</code> path. We&#8217;ll look at that next time.</p>\n<p>¹ Now, you might notice that there is no requirement that the <code>IDCANCEL</code> button be in the tab order, or that it even be visible. The dialog manager merely checks whether it is enabled. Therefore, you might be tempted to control these actions by disabling your (invisible, non-tabbable) <code>IDCANCEL</code> button. This is sneaky, but it will probably confuse assistive technology tools, and anybody else who inspects the window hierarchy, and besides, it&#8217;s more complicated than the other alternatives presented here.</p>\n<p>The post <a href="https://devblogs.microsoft.com/oldnewthing/20260224-00/?p=112082">Customizing the ways the dialog manager dismisses itself: Isolating the Close pathway</a> appeared first on <a href="https://devblogs.microsoft.com/oldnewthing">The Old New Thing</a>.</p>'}

---

*抓取时间: 2026-02-25 00:06:47*
