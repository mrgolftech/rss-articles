# CI In a Box

**来源:** [matklad.github.io](https://matklad.github.io)
**发布时间:** 2026-02-06T00:00:00+00:00
**链接:** https://matklad.github.io/2026/02/06/ci-in-a-box.html

---

{'type': 'text/html', 'language': None, 'base': 'https://matklad.github.io/2026/02/06/ci-in-a-box.html', 'value': '<header>\n  <h1>CI In a Box</h1>\n  <time class="meta" datetime="2026-02-06">Feb 6, 2026</time>\n</header>\n<p>I wrote <a href="https://matklad.github.io/2026/01/20/vibecoding-2.html"><code>box</code></a>, a thin wrapper around ssh\nfor running commands on remote machines. I want a box-shaped interface for CI:</p>\n\n<figure class="code-block">\n\n\n<pre><code><span class="line"><span class="hl-keyword">const</span> repository = <span class="hl-string">&quot;git@forge.com/me/my-project&quot;</span>;</span>\n<span class="line"><span class="hl-keyword">const</span> commit_sha = <span class="hl-title class_">Deno</span>.<span class="hl-property">env</span>[<span class="hl-string">&quot;COMMIT&quot;</span>];</span>\n<span class="line"></span>\n<span class="line"><span class="hl-keyword">const</span> runners = <span class="hl-keyword">await</span> <span class="hl-title class_">Promise</span>.<span class="hl-title function_">all</span>(</span>\n<span class="line">    [<span class="hl-string">&quot;windows-latest&quot;</span>, <span class="hl-string">&quot;mac-latest&quot;</span>, <span class="hl-string">&quot;linux-latest&quot;</span>]</span>\n<span class="line">        .<span class="hl-title function_">map</span>(<span class="hl-function">(<span class="hl-params">os</span>) =&gt;</span> $<span class="hl-string">`box create <span class="hl-subst">${os}</span>`</span>)</span>\n<span class="line">);</span>\n<span class="line"></span>\n<span class="line"><span class="hl-keyword">await</span> <span class="hl-title class_">Promise</span>.<span class="hl-title function_">all</span>(runners.<span class="hl-title function_">map</span>(<span class="hl-keyword">async</span> ($runner) =&gt; {</span>\n<span class="line">    <span class="hl-keyword">await</span> $<span class="hl-string">`box run <span class="hl-subst">${runner}</span></span></span>\n<span class="line"><span class="hl-string">        git clone <span class="hl-subst">${repository}</span> .`</span>;</span>\n<span class="line"></span>\n<span class="line">    <span class="hl-keyword">await</span> $<span class="hl-string">`box run <span class="hl-subst">${runner}</span></span></span>\n<span class="line"><span class="hl-string">        git switch --detach <span class="hl-subst">${commit_sha}</span>`</span>;</span>\n<span class="line"></span>\n<span class="line">    <span class="hl-keyword">await</span> $<span class="hl-string">`box run <span class="hl-subst">${runner}</span></span></span>\n<span class="line"><span class="hl-string">        ./zig/download.ps1`</span>;</span>\n<span class="line"></span>\n<span class="line">    <span class="hl-keyword">await</span> $<span class="hl-string">`box run <span class="hl-subst">${runner}</span></span></span>\n<span class="line"><span class="hl-string">        ./zig/zig build test`</span>;</span>\n<span class="line">}));</span></code></pre>\n\n</figure>\n<p>That is, the controlling CI machine runs a user-supplied script, whose status code will be the\nultimate result of a CI run. The script doesn’t run the project’s tests directly. Instead, it shells out\nto a proxy binary that forwards the command to a runner box with whichever OS, CPU, and other\nenvironment required.</p>\n<p>The hard problems are in the\n<span class="display"><code>["windows-latest", "mac-latest", "linux-latest"]</code></span>\npart:</p>\n<ul>\n<li>\nOne of them is not UNIX.\n</li>\n<li>\nOne of them has licensing&amp;hardware constraints that make per-minute billed VMs tricky (but not\nimpossible, as GitHub Actions does that).\n</li>\n<li>\nAll of them are moving targets, and require <em>someone</em> to do the OS upgrade work, which\n<a href="https://www.azabani.com/2025/12/18/shoestring-web-engine-ci.html#:~:text=have%20to%20be-,done%20by%20hand,-.%20And%20this%20is">might involve pointing and clicking</a>.\n</li>\n</ul>\n<p>CI discourse amuses me — everyone complains about bad YAML, and it <em>is</em> bad, but most of the\nYAML (and associated reproducibility and debugging problems) is avoidable. Pick an appropriate\nposition on a dial that includes</p>\n<ul>\n<li>\nwriting a bash script,\n</li>\n<li>\nwriting a script\n<a href="https://www.teamten.com/lawrence/writings/java-for-everything.html">in the language you already use</a>,\n</li>\n<li>\nusing a\n<a href="https://neugierig.org/software/blog/2026/01/smallest-build-system.html">small build system</a>,\n</li>\n<li>\nusing a medium-sized one like <code>make</code> or <code>zig build</code>, or\n</li>\n<li>\nusing a large one like <code>nix</code> or <code>buck2</code>.\n</li>\n</ul>\n<p>What you can’t just do by writing a smidgen of text is getting the heterogeneous fleet of runners.\nAnd you need heterogeneous fleet of runners if some of the software you are building is\ncross-platform.</p>\n<hr />\n<p>If you go that way, be mindful that</p>\n\n<figure class="blockquote">\n<blockquote><p>The SSH wire protocol only takes a single string as the command, with the expectation that it\nshould be passed to a shell by the remote end.</p>\n</blockquote>\n<figcaption><cite><a href="https://www.chiark.greenend.org.uk/~cjwatson/blog/ssh-quoting.html">Colin Watson on SSH quoting</a></cite></figcaption>\n</figure>\n<p>In other words, while SSH supports syntax like\n<span class="display"><code>ssh $HOST cmd arg1 arg2</code>,</span>\nit just blindly intersperses all arguments with a space. Amusing to think that our entire cloud\ninfrastructure is built on top of <a href="https://matklad.github.io/2021/07/30/shell-injection.html">shell injection</a>!</p>\n<p>This, and the need to ensure no processes are left behind unintentionally after executing a remote\ncommand, means that you can’t “just” use SSH here if you are building something solid.</p>'}

---

*抓取时间: 2026-02-06 17:06:39*
