
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="技术博客文章聚合 - Hacker News 2025年最受欢迎的博客">
      
      
        <meta name="author" content="OpenClaw">
      
      
        <link rel="canonical" href="https://mrgolftech.github.io/rss-articles/keygen.sh/How%20to%20Implement%20API%20Key%20Authentication%20in%20Rails%20Without%20Devise_20260205/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>How to Implement API Key Authentication in Rails Without Devise - Hacker News 精选博客</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-implement-api-key-authentication-in-rails-without-devise" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Hacker News 精选博客" class="md-header__button md-logo" aria-label="Hacker News 精选博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Hacker News 精选博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              How to Implement API Key Authentication in Rails Without Devise
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mrgolftech/rss-articles" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    rss-articles
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../blogs/" class="md-tabs__link">
        
  
  
    
  
  所有博客

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Hacker News 精选博客" class="md-nav__button md-logo" aria-label="Hacker News 精选博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Hacker News 精选博客
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mrgolftech/rss-articles" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    rss-articles
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    首页
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../blogs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    所有博客
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/mrgolftech/rss-articles/edit/master/docs/keygen.sh/How to Implement API Key Authentication in Rails Without Devise_20260205.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg>
    </a>
  
  


<h1 id="how-to-implement-api-key-authentication-in-rails-without-devise">How to Implement API Key Authentication in Rails Without Devise<a class="headerlink" href="#how-to-implement-api-key-authentication-in-rails-without-devise" title="Permanent link">&para;</a></h1>
<p><strong>来源:</strong> https://keygen.sh
<strong>链接:</strong> https://keygen.sh/blog/how-to-implement-api-key-authentication-in-rails-without-devise/
<strong>日期:</strong> Fri, 16 Apr 2021 05:00:00 GMT</p>
<hr />
<p><a href="https://github.com/keygen-sh/keygen-api">Keygen is Fair SourceStar us on GitHub <em>arrow_right_alt</em></a></p>
<p><a href="/"> Keygen</a></p>
<p><em>menu</em></p>
<ul>
<li>Use Cases <em>expand_more</em><ul>
<li><a href="/software-licensing-api/"> <em>lock_open</em> Software Application Licensing</a>Use Keygen's flagship software licensing API to add license key validation, device activation and entitlements to any software product. </li>
<li><a href="/software-distribution-api/"><em>cloud_download</em> Software Artifact Distribution</a>Use Keygen's supplementary software distribution API to securely deliver artifacts and offer automatic updates to licensed users. </li>
<li><a href="/integrate/zapier/"><em>bolt</em> No-code Licensing Automation</a>Use Zapier to integrate Keygen with your favorite tools, such as Stripe for payments, and Postmark for transactional emails. No code required. </li>
<li><a href="/for-on-prem-software/">__For On-Premise/Multi-Prem</a></li>
<li><a href="/for-go-programs/"> __For Go Programs</a></li>
<li><a href="/for-ios-apps/"> __For iOS Apps</a></li>
<li><a href="/for-mac-apps/"> __For Mac Applications</a></li>
<li><a href="/for-android-apps/"> __For Android Apps</a></li>
<li><a href="/for-windows-programs/"> __For Windows Programs</a></li>
<li><a href="/for-docker-images/"> __For Container Images</a></li>
<li><a href="/for-electron-apps/"> __For Electron Apps</a></li>
<li><a href="/for-wordpress-plugins/"> __For WordPress Plugins</a></li>
<li><a href="/for-tauri-apps/"> For Tauri Apps</a></li>
<li><a href="/for-python-packages/"> __For Python Packages</a></li>
<li><a href="/for-composer-packages/"> __For PHP Packages</a></li>
<li><a href="/for-npm-packages/"> __For Node Packages</a></li>
<li><a href="/for-rubygems/"> __For RubyGems</a></li>
</ul>
</li>
<li>Demos <em>expand_more</em><ul>
<li><a href="/demo/license-activation-portal/"> <em>phonelink_lock</em> License Activation Portal Demo</a></li>
<li><a href="/demo/license-key-validation/"> <em>vpn_key</em> License Key Validation Demo</a></li>
<li><a href="https://app.keygen.sh/demo">Try Dashboard Demo </a></li>
</ul>
</li>
<li>Developers <em>expand_more</em><ul>
<li><a href="/docs/self-hosting/"> <em>dns</em> Self-Host Keygen</a>Learn how to self-host Keygen's Community Edition for free, or self-host our Enterprise Edition for your business. </li>
<li><a href="/docs/relay/"><em>lan</em> Keygen Relay NEW</a>Use Keygen Relay to securely distribute node-locked licenses in offline and air-gapped environments. </li>
<li><a href="/docs/cli/"><em>terminal</em> Developer CLI</a>Use Keygen's official CLI to sign and publish software releases. Integrate with our SDKs for secure automatic upgrades. </li>
<li><a href="/docs/"><em>import_contacts</em> Documentation </a></li>
<li><a href="/docs/api/"><em>data_object</em> API Reference </a></li>
<li><a href="/changelog/"><em>update</em> Changelog </a></li>
<li><a href="/security/"><em>security</em> Security </a></li>
<li><a href="https://github.com/keygen-sh/keygen-api"><em>code</em> Source Code </a></li>
</ul>
</li>
<li>Company <em>expand_more</em><ul>
<li><a href="https://github.com/keygen-sh/keygen-api"> __Read the Source Code</a> Keygen is an Fair Source software licensing and distribution API. View the source code on GitHub to learn more. <a href="/build-vs-buy/"><em>compare_arrows</em> Build vs Buy</a>Businesses of all sizes face the question of whether to build or buy a licensing solution. </li>
<li><a href="/open-source/"><em>volunteer_activism</em> Open Source </a></li>
<li><a href="/license/"><em>description</em> Fair Source </a></li>
<li><a href="/about/"><em>business</em> About </a></li>
<li><a href="/jobs/"><em>badge</em> Careers </a></li>
<li><a href="/blog/"><em>article</em> Blog </a></li>
<li><a href="/cdn-cgi/l/email-protection#91e2e4e1e1fee3e5d1faf4e8f6f4ffbfe2f9"><em>support</em> Get Support </a></li>
</ul>
</li>
<li><a href="/pricing/">Pricing </a></li>
<li><a href="https://app.keygen.sh/login">Log in </a></li>
<li><a href="https://app.keygen.sh/register?plan=984180df-07b3-4dc1-b138-ca68a0f913ed">Sign Up</a></li>
</ul>
<h1 id="how-to-implement-api-key-authentication-in-rails-without-devise_1">How to Implement API Key Authentication in Rails Without Devise<a class="headerlink" href="#how-to-implement-api-key-authentication-in-rails-without-devise_1" title="Permanent link">&para;</a></h1>
<p>Friday, April 16th 2021</p>
<p>It's gotta be at least once a week that I see somebody on /r/rails or Stack Overflow asking how to implement API key authentication using Ruby on Rails. Most of the time they ask how to do it with the ubiquitous Devise gem, or the accepted answer points them in that direction. And everytime I think to myself, "why is everybody using Devise for something as simple as API key authentication?"</p>
<p>Devise was created to handle browser-based authentication via cookies for run-of-the-mill, non-API, Rails applications. Devise really shines in its simple and secure session management, ready-to-go view and mailer templates, and support for things like SSO and OAuth using OmniAuth.</p>
<p>But API's don't utilize sessions, or views. (Or at least they shouldn't!)</p>
<p>To make matters even more confusing â the Devise repo kind of seems like they don't even recommend using Devise for API-mode apps. Concerning Rails' API-mode, their README states "we still don't know the full extent of [API-mode] compatibility."</p>
<p>So why are people using and recommending Devise for APIs?</p>
<p>I think they're using Devise simply because they are unaware of how easy it is to implement API key authentication without Devise. When it comes to authentication, Ruby on Rails is a batteries-included framework.</p>
<p>Devise is over-kill for an API.</p>
<h2 id="generating-a-new-rails-api">Generating a new Rails API<a class="headerlink" href="#generating-a-new-rails-api" title="Permanent link">&para;</a></h2>
<p>To kick things off, let's create a new Rails API app:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails new . --api --database postgresql \

    --skip-active-storage \

    --skip-action-cable

$ rails new . --api --database postgresql \
    --skip-active-storage \
    --skip-action-cable
_content_copy_
</code></pre></div>
<p>Now that we have a new Rails app in API-mode, excluding a little bit of cruft that we don't need like Active Storage and Action Cable, let's move onto our models.</p>
<h2 id="creating-a-user-model">Creating a user model<a class="headerlink" href="#creating-a-user-model" title="Permanent link">&para;</a></h2>
<p>First up, we have our <code>User</code>. For that, we'll need a <code>users</code> table. Pretty standard stuff. Let's generate a migration:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails g migration CreateUsers

$ rails g migration CreateUsers
_content_copy_
</code></pre></div>
<p>We'll populate the migration with the following:</p>
<div class="language-text highlight"><pre><span></span><code>class CreateUsers &lt; ActiveRecord::Migration[5.2]

  def change

    create_table :users do |t|

      t.string :email, null: false

      t.string :password_digest, null: false

      t.timestamps null: false

    end



    add_index :users, :email, unique: true

  end

end

class CreateUsers &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :users do |t|
      t.string :email, null: false
      t.string :password_digest, null: false
      t.timestamps null: false
    end

    add_index :users, :email, unique: true
  end
end
_content_copy_
</code></pre></div>
<p>Then we'll apply it:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails db:migrate

$ rails db:migrate
_content_copy_
</code></pre></div>
<p>Lastly, we'll create the actual <code>User</code> model:</p>
<div class="language-text highlight"><pre><span></span><code>class User &lt; ApplicationRecord

  has_secure_password

end

class User &lt; ApplicationRecord
  has_secure_password
end
_content_copy_
</code></pre></div>
<p>Simple enough. Rails has out-of-the-box support for user password authentication using the <code>has_secure_password</code> concern. I run across Rails devs all the time who don't know that, so I figured I'd mention it. Again, You Don't Need Deviseâ¢.</p>
<h2 id="creating-an-api-key-model">Creating an API key model<a class="headerlink" href="#creating-an-api-key-model" title="Permanent link">&para;</a></h2>
<p>Moving on, we'll need another model. An <code>ApiKey</code>. So let's go ahead and create the <code>api_keys</code> table as well as the model class.</p>
<div class="language-text highlight"><pre><span></span><code>$ rails g migration CreateApiKeys

$ rails g migration CreateApiKeys
_content_copy_
</code></pre></div>
<p>Then fill it with the following:</p>
<div class="language-text highlight"><pre><span></span><code>class CreateApiKeys &lt; ActiveRecord::Migration[5.2]

  def change

    create_table :api_keys do |t|

      t.integer :bearer_id, null: false

      t.string :bearer_type, null: false

      t.string :token, null: false

      t.timestamps null: false

    end



    add_index :api_keys, [:bearer_id, :bearer_type]

    add_index :api_keys, :token, unique: true

  end

end

class CreateApiKeys &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :api_keys do |t|
      t.integer :bearer_id, null: false
      t.string :bearer_type, null: false
      t.string :token, null: false
      t.timestamps null: false
    end

    add_index :api_keys, [:bearer_id, :bearer_type]
    add_index :api_keys, :token, unique: true
  end
end
_content_copy_
</code></pre></div>
<p>Note the <code>bearer_id</code> and <code>bearer_type</code> columns, instead of a <code>user_id</code> column. We're going to be defining a polymorphic API key model, meaning not just a <code>User</code> can have an API key. We can get more into multiple "bearers" later, though.</p>
<p>Then we'll apply the migration:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails db:migrate

$ rails db:migrate
_content_copy_
</code></pre></div>
<p>Next, in the same vein as our user, we'll create the <code>ApiKey</code> model:</p>
<div class="language-text highlight"><pre><span></span><code>class ApiKey &lt; ApplicationRecord

  belongs_to :bearer, polymorphic: true

end

class ApiKey &lt; ApplicationRecord
  belongs_to :bearer, polymorphic: true
end
_content_copy_
</code></pre></div>
<p>Lastly, we'll want to add the API key association to the user model.</p>
<div class="language-text highlight"><pre><span></span><code> class User &lt; ApplicationRecord

+  has_many :api_keys, as: :bearer

+

   has_secure_password

 end

class User &lt; ApplicationRecord
  has_many :api_keys, as: :bearer # [tl! ++]
  # [tl! ++]
  has_secure_password
end
_content_copy_
</code></pre></div>
<p>Again, note the <code>as: :bearer</code> option. This ensures that the user, at least from the API key's perspective, is referred to as the API key "bearer."</p>
<h2 id="verifying-our-work">Verifying our work<a class="headerlink" href="#verifying-our-work" title="Permanent link">&para;</a></h2>
<p>Alright â so we have our tables, a <code>User</code> model, and an <code>ApiKey</code> model. What's next? Well, I always like to test things as I go using the Rails console, so let's do that real quick before we dive too deep into things.</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; User.create! email: &#39;[[email protected]](/cdn-cgi/l/email-protection)&#39;, password: &#39;secret&#39;

# You don&#39;t have bcrypt installed in your application. Please add it to your Gemfile and run bundle install

# Traceback (most recent call last):

#         3: from (irb):3

#         2: from app/models/user.rb:1:in `&lt;main&gt;&#39;

#         1: from app/models/user.rb:4:in `&lt;class:User&gt;&#39;

# LoadError (cannot load such file -- bcrypt)

$ rails c
&gt; User.create! email: &#39;zeke@keygen.example&#39;, password: &#39;secret&#39;
# You don&#39;t have bcrypt installed in your application. Please add it to your Gemfile and run bundle install
# Traceback (most recent call last):
#         3: from (irb):3
#         2: from app/models/user.rb:1:in `&lt;main&gt;&#39;
#         1: from app/models/user.rb:4:in `&lt;class:User&gt;&#39;
# LoadError (cannot load such file -- bcrypt)
_content_copy_
</code></pre></div>
<p>Oops. It's been awhile since I created a new Rails app, so let's uncomment <code>bcrypt</code> from our Gemfile real quick, run Bundler, then try again.</p>
<div class="language-text highlight"><pre><span></span><code>-# gem &#39;bcrypt&#39;, &#39;~&gt; 3.1.7&#39; #

+gem &#39;bcrypt&#39;, &#39;~&gt; 3.1.7&#39;

# gem &#39;bcrypt&#39;, &#39;~&gt; 3.1.7&#39; # [tl! --]
gem &#39;bcrypt&#39;, &#39;~&gt; 3.1.7&#39; # [tl! ++]
_content_copy_
</code></pre></div>
<p>Then run Bundler:</p>
<div class="language-text highlight"><pre><span></span><code>$ bundle

$ bundle
_content_copy_
</code></pre></div>
<p>Now let's try that again:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; User.create! email: &#39;[[email protected]](/cdn-cgi/l/email-protection)&#39;, password: &#39;secret&#39;

# =&gt; #&lt;User id: 1, email: &quot;[[email protected]](/cdn-cgi/l/email-protection)&quot;, password_digest: &quot;$2a$10$RAR1bk.3VlusLgAg.tvEbOOI3govZfQg/Xibj0E/GYN...&quot;, created_at: &quot;2021-04-16 13:45:30&quot;, updated_at: &quot;2021-04-16 13:45:30&quot;&gt;

$ rails c
&gt; User.create! email: &#39;zeke@keygen.example&#39;, password: &#39;secret&#39;
# =&gt; #&lt;User id: 1, email: &quot;zeke@keygen.example&quot;, password_digest: &quot;$2a$10$RAR1bk.3VlusLgAg.tvEbOOI3govZfQg/Xibj0E/GYN...&quot;, created_at: &quot;2021-04-16 13:45:30&quot;, updated_at: &quot;2021-04-16 13:45:30&quot;&gt;
_content_copy_
</code></pre></div>
<p>Perfection.</p>
<p>Let's go ahead and test a few more things, like user password authentication, and maybe we can even create a couple API keys, just for kicks.</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; zeke = User.first

&gt; zeke.authenticate(&#39;secret&#39;)

# =&gt; #&lt;User id: 1, email: &quot;[[email protected]](/cdn-cgi/l/email-protection)&quot;, password_digest: &quot;$2a$10$RAR1bk.3VlusLgAg.tvEbOOI3govZfQg/Xibj0E/GYN...&quot;, created_at: &quot;2021-04-16 13:45:30&quot;, updated_at: &quot;2021-04-16 13:45:30&quot;&gt;

&gt; zeke.authenticate(&#39;foo&#39;)

# =&gt; false

&gt; zeke.api_keys

# =&gt; #&lt;ActiveRecord::Associations::CollectionProxy []&gt;

&gt; zeke.api_keys.create! token: SecureRandom.hex

# =&gt; #&lt;ApiKey id: 1, bearer_id: 1, bearer_type: &quot;User&quot;, token: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;, created_at: &quot;2021-04-16 13:56:42&quot;, updated_at: &quot;2021-04-16 13:56:42&quot;&gt;

&gt; zeke.api_keys

# =&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;ApiKey id: 1, bearer_id: 1, bearer_type: &quot;User&quot;, token: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;, created_at: &quot;2021-04-16 13:56:42&quot;, updated_at: &quot;2021-04-16 13:56:42&quot;&gt;]&gt;

$ rails c
&gt; zeke = User.first
&gt; zeke.authenticate(&#39;secret&#39;)
# =&gt; #&lt;User id: 1, email: &quot;zeke@keygen.example&quot;, password_digest: &quot;$2a$10$RAR1bk.3VlusLgAg.tvEbOOI3govZfQg/Xibj0E/GYN...&quot;, created_at: &quot;2021-04-16 13:45:30&quot;, updated_at: &quot;2021-04-16 13:45:30&quot;&gt;
&gt; zeke.authenticate(&#39;foo&#39;)
# =&gt; false
&gt; zeke.api_keys
# =&gt; #&lt;ActiveRecord::Associations::CollectionProxy []&gt;
&gt; zeke.api_keys.create! token: SecureRandom.hex
# =&gt; #&lt;ApiKey id: 1, bearer_id: 1, bearer_type: &quot;User&quot;, token: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;, created_at: &quot;2021-04-16 13:56:42&quot;, updated_at: &quot;2021-04-16 13:56:42&quot;&gt;
&gt; zeke.api_keys
# =&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;ApiKey id: 1, bearer_id: 1, bearer_type: &quot;User&quot;, token: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;, created_at: &quot;2021-04-16 13:56:42&quot;, updated_at: &quot;2021-04-16 13:56:42&quot;&gt;]&gt;
_content_copy_
</code></pre></div>
<p>Everything looks solid. What's next?</p>
<h2 id="the-route-to-api-key-authentication">The route to API key authentication<a class="headerlink" href="#the-route-to-api-key-authentication" title="Permanent link">&para;</a></h2>
<p>In this example, we're going to be defining 3 routes:</p>
<ol>
<li><code>POST /api-keys</code>: to create a new API key i.e. a standard 'login'</li>
<li><code>DELETE /api-keys</code>: to revoke the current API key i.e. 'logout'</li>
<li><code>GET /api-keys</code>: to list a user's API keys</li>
</ol>
<p>Let's open up our <code>config/routes.rb</code> file and plop this in there:</p>
<div class="language-text highlight"><pre><span></span><code>Rails.application.routes.draw do

  post &#39;/api-keys&#39;, to: &#39;api_keys#create&#39;

  delete &#39;/api-keys&#39;, to: &#39;api_keys#destroy&#39;

  get &#39;/api-keys&#39;, to: &#39;api_keys#index&#39;

end

Rails.application.routes.draw do
  post &#39;/api-keys&#39;, to: &#39;api_keys#create&#39;
  delete &#39;/api-keys&#39;, to: &#39;api_keys#destroy&#39;
  get &#39;/api-keys&#39;, to: &#39;api_keys#index&#39;
end
_content_copy_
</code></pre></div>
<p>You could probably make this more RESTful by following the standard Rails <code>resources</code> route conventions, but I figured managing API key IDs for the purpose of revocation would be a bit too much for this post.</p>
<h2 id="a-concern-about-api-key-authentication">A concern about API key authentication<a class="headerlink" href="#a-concern-about-api-key-authentication" title="Permanent link">&para;</a></h2>
<p>What's the concern? ~~Nothing, really.~~ (<em>Update: April 17th, 2021</em> â well, that was a lie â there are a couple concerns, but we'll touch on them later.)</p>
<p>For now, we're going to be creating a typical Rails concern that allows controllers to require API key authentication:</p>
<div class="language-text highlight"><pre><span></span><code>module ApiKeyAuthenticatable

  extend ActiveSupport::Concern



  include ActionController::HttpAuthentication::Basic::ControllerMethods

  include ActionController::HttpAuthentication::Token::ControllerMethods



  attr_reader :current_api_key

  attr_reader :current_bearer



  # Use this to raise an error and automatically respond with a 401 HTTP status

  # code when API key authentication fails

  def authenticate_with_api_key!

    @current_bearer = authenticate_or_request_with_http_token &amp;method(:authenticator)

  end



  # Use this for optional API key authentication

  def authenticate_with_api_key

    @current_bearer = authenticate_with_http_token &amp;method(:authenticator)

  end



  private



  attr_writer :current_api_key

  attr_writer :current_bearer



  def authenticator(http_token, options)

    @current_api_key = ApiKey.find_by token: http_token



    current_api_key&amp;.bearer

  end

end

module ApiKeyAuthenticatable
  extend ActiveSupport::Concern

  include ActionController::HttpAuthentication::Basic::ControllerMethods
  include ActionController::HttpAuthentication::Token::ControllerMethods

  attr_reader :current_api_key
  attr_reader :current_bearer

  # Use this to raise an error and automatically respond with a 401 HTTP status
  # code when API key authentication fails
  def authenticate_with_api_key!
    @current_bearer = authenticate_or_request_with_http_token &amp;method(:authenticator)
  end

  # Use this for optional API key authentication
  def authenticate_with_api_key
    @current_bearer = authenticate_with_http_token &amp;method(:authenticator)
  end

  private

  attr_writer :current_api_key
  attr_writer :current_bearer

  def authenticator(http_token, options)
    @current_api_key = ApiKey.find_by token: http_token

    current_api_key&amp;.bearer
  end
end
_content_copy_
</code></pre></div>
<p>Like I said, Rails comes batteries-included. By including just a couple core classes, we can take advantage of some useful methods:</p>
<ul>
<li><code>#authenticate_or_request_with_http_token</code>: authenticate with an HTTP token, otherwise automatically request authentication, i.e. Rails will respond with a <code>401 Unauthenticated</code> HTTP status code.</li>
<li><code>#authenticate_with_http_token</code>: attempt to authenticate with an HTTP token, but don't raise an error if the token ends up being <code>nil</code>.</li>
</ul>
<p>In both cases, we're going to be passing in our <code>#authenticator</code> method to handle the API key lookup. Rails will handle the rest. We'll be storing the current API key bearer and the current API key into controller-level instance variables, <code>current_bearer</code> and <code>current_api_key</code>, respectively.</p>
<p>These methods will handle parsing of the <code>Authorization</code> HTTP header. There are multiple HTTP authorization schemes, but these 2 methods will only care about the <code>Bearer</code> scheme. We'll get into others in a second.</p>
<p>An <code>Authorization</code> header for an API key will look something like this:</p>
<div class="language-text highlight"><pre><span></span><code>Authorization: Bearer 5c8e4327fd8b2bf3118f82b13890d89d

Authorization: Bearer 5c8e4327fd8b2bf3118f82b13890d89d
_content_copy_
</code></pre></div>
<p>This is how your users will likely be interacting with your API.</p>
<p>Real quick, let's verify that our routes are correct:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails routes

# Verb    URI Pattern          Controller#Action

# POST    /api-keys(.:format)  api_keys#create

# DELETE  /api-keys(.:format)  api_keys#destroy

# GET     /api-keys(.:format)  api_keys#index

$ rails routes
# Verb    URI Pattern          Controller#Action
# POST    /api-keys(.:format)  api_keys#create
# DELETE  /api-keys(.:format)  api_keys#destroy
# GET     /api-keys(.:format)  api_keys#index
_content_copy_
</code></pre></div>
<p>Looks good. Onward!</p>
<h2 id="controlling-api-key-authentication">Controlling API key authentication<a class="headerlink" href="#controlling-api-key-authentication" title="Permanent link">&para;</a></h2>
<p>I know, I know â we've written a lot of code and haven't tested anything in awhile. Let's define an empty controller so that we can start testing our API using <code>curl</code>.</p>
<div class="language-text highlight"><pre><span></span><code>class ApiKeysController &lt; ApplicationController

  def index

  end



  def create

  end



  def destroy

  end

end

class ApiKeysController &lt; ApplicationController
  def index
  end

  def create
  end

  def destroy
  end
end
_content_copy_
</code></pre></div>
<p>Okay, let's do a quick smoke test of our endpoints using <code>curl</code>:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X POST http://localhost:3000/api-keys

# &lt; HTTP/1.1 204 No Content

$ curl -v -X DELETE http://localhost:3000/api-keys

# &lt; HTTP/1.1 204 No Content

$ curl -v -X GET http://localhost:3000/api-keys

# &lt; HTTP/1.1 204 No Content

$ curl -v -X POST http://localhost:3000/api-keys
# &lt; HTTP/1.1 204 No Content
$ curl -v -X DELETE http://localhost:3000/api-keys
# &lt; HTTP/1.1 204 No Content
$ curl -v -X GET http://localhost:3000/api-keys
# &lt; HTTP/1.1 204 No Content
_content_copy_
</code></pre></div>
<p>Good â no <code>404</code> or <code>5xx</code> errors. Now let's add our authenticatable concern to our controller, and define a route that requires an API key and one where an API key is optional:</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKeysController &lt; ApplicationController

+  include ApiKeyAuthenticatable

+

+  # Require token authentication for index

+  prepend_before_action :authenticate_with_api_key!, only: [:index]

+

+  # Optional token authentication for logout

+  prepend_before_action :authenticate_with_api_key, only: [:destroy]



   def index

   end



   def create

   end



   def destroy

   end

 end

class ApiKeysController &lt; ApplicationController
  include ApiKeyAuthenticatable # [tl! ++]
  # [tl! ++]
  # Require token authentication for index                             [tl! ++]
  prepend_before_action :authenticate_with_api_key!, only: [:index] # [tl! ++]
  # [tl! ++]
  # Optional token authentication for logout                           [tl! ++]
  prepend_before_action :authenticate_with_api_key, only: [:destroy] # [tl! ++]

  def index
  end

  def create
  end

  def destroy
  end
end
_content_copy_
</code></pre></div>
<p>Let's re-run our smoke test:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X POST http://localhost:3000/api-keys

# &lt; HTTP/1.1 204 No Content

$ curl -v -X DELETE http://localhost:3000/api-keys

# &lt; HTTP/1.1 204 No Content

$ curl -v -X GET http://localhost:3000/api-keys

# &lt; HTTP/1.1 401 Unauthorized

$ curl -v -X POST http://localhost:3000/api-keys
# &lt; HTTP/1.1 204 No Content
$ curl -v -X DELETE http://localhost:3000/api-keys
# &lt; HTTP/1.1 204 No Content
$ curl -v -X GET http://localhost:3000/api-keys
# &lt; HTTP/1.1 401 Unauthorized
_content_copy_
</code></pre></div>
<p>Notice anything different? Our <code>GET</code> request now responds with a <code>401</code> HTTP status code, as intended. Remember â our <code>POST</code> endpoint doesn't require authentication, and authentication is optional for the <code>DELETE</code> endpoint.</p>
<h2 id="creating-our-first-api-key">Creating our first API key<a class="headerlink" href="#creating-our-first-api-key" title="Permanent link">&para;</a></h2>
<p>Everything looks good, so let's go ahead and work on the <code>#create</code> action. As touched on earlier, this is going to be our login endpoint.</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKeysController &lt; ApplicationController

   include ApiKeyAuthenticatable



   # Require API key authentication for index

   prepend_before_action :authenticate_with_api_key!, only: [:index]



   # Optional API key authentication for logout

   prepend_before_action :authenticate_with_api_key, only: [:destroy]



   def index

   end



   def create

+    authenticate_with_http_basic do |email, password|

+      user = User.find_by email: email

+

+      if user&amp;.authenticate(password)

+        api_key = user.api_keys.create! token: SecureRandom.hex

+

+        render json: api_key, status: :created and return

+      end

     end



     render status: :unauthorized

   end



   def destroy

   end

 end

class ApiKeysController &lt; ApplicationController
  include ApiKeyAuthenticatable

  # Require API key authentication for index
  prepend_before_action :authenticate_with_api_key!, only: [:index]

  # Optional API key authentication for logout
  prepend_before_action :authenticate_with_api_key, only: [:destroy]

  def index
  end

  def create
    authenticate_with_http_basic do |email, password| # [tl! ++]
      user = User.find_by email: email # [tl! ++]
      # [tl! ++]
      if user&amp;.authenticate(password) # [tl! ++]
        api_key = user.api_keys.create! token: SecureRandom.hex # [tl! ++]
        # [tl! ++]
        render json: api_key, status: :created and return # [tl! ++]
      end # [tl! ++]
    end

    render status: :unauthorized
  end

  def destroy
  end
end
_content_copy_
</code></pre></div>
<p>Once again, we're going to be utilizing another method provided by Rails to handle the grunt-work of HTTP authentication. Like the previously used method <code>authenticate_with_http_token</code>, the <code>authenticate_with_http_basic</code> will parse the <code>Authorization</code> header. Unlike the token method variant caring about the <code>Bearer</code> scheme, the basic variant only cares about the <code>Basic</code> scheme.</p>
<p>A basic <code>Authorization</code> header will look something like this:</p>
<div class="language-text highlight"><pre><span></span><code>Authorization: Basic [[email protected]](/cdn-cgi/l/email-protection):secret

Authorization: Basic zeke@keygen.example:secret
_content_copy_
</code></pre></div>
<p>The actual email and password values will be base64 encoded, but for example purposes we're omitting that detail. Rails will automatically handle parsing and decoding these values. You Don't Need Deviseâ¢.</p>
<p>Now that we've written hundreds of lines of code, let's errâ¦ wait. We've only written about 60 lines of application code. A lot of people will make API key authentication sound harder and more complicated than it really is. It's really not that hard, and it's not complicated, because Rails does most of the heavy lifting for us.</p>
<p>Anyways â let's create our first API key:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X POST http://localhost:3000/api-keys \

    -u [[email protected]](/cdn-cgi/l/email-protection):secret

# &lt; HTTP/1.1 201 Created

# {

#   &quot;id&quot;: 2,

#   &quot;bearer_id&quot;: 1,

#   &quot;bearer_type&quot;: &quot;User&quot;,

#   &quot;token&quot;: &quot;5d1524c7e2486f98e1b65cbe1cdeb258&quot;,

#   &quot;created_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;,

#   &quot;updated_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;

# }

$ curl -v -X POST http://localhost:3000/api-keys \
    -u zeke@keygen.example:secret
# &lt; HTTP/1.1 201 Created
# {
#   &quot;id&quot;: 2,
#   &quot;bearer_id&quot;: 1,
#   &quot;bearer_type&quot;: &quot;User&quot;,
#   &quot;token&quot;: &quot;5d1524c7e2486f98e1b65cbe1cdeb258&quot;,
#   &quot;created_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;,
#   &quot;updated_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;
# }
_content_copy_
</code></pre></div>
<p>Nice, but before we celebrate, let's make sure a bad password and a bad email are properly rejected with a <code>401</code> response, respectively:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X POST http://localhost:3000/api-keys \

    -u [[email protected]](/cdn-cgi/l/email-protection):foo

# &lt; HTTP/1.1 401 Unauthorized

$ curl -v -X POST http://localhost:3000/api-keys \

    -u [[email protected]](/cdn-cgi/l/email-protection):secret

# &lt; HTTP/1.1 401 Unauthorized

$ curl -v -X POST http://localhost:3000/api-keys \
    -u zeke@keygen.example:foo
# &lt; HTTP/1.1 401 Unauthorized
$ curl -v -X POST http://localhost:3000/api-keys \
    -u foo@keygen.example:secret
# &lt; HTTP/1.1 401 Unauthorized
_content_copy_
</code></pre></div>
<h2 id="listing-our-api-keys">Listing our API keys<a class="headerlink" href="#listing-our-api-keys" title="Permanent link">&para;</a></h2>
<p>Up next, let's work on our <code>#index</code> action. Go ahead and open that controller up again and let's list the API keys of the <code>current_bearer</code>.</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKeysController &lt; ApplicationController

   include ApiKeyAuthenticatable



   # Require API key authentication for index

   prepend_before_action :authenticate_with_api_key!, only: [:index]



   # Optional API key authentication for logout

   prepend_before_action :authenticate_with_api_key, only: [:destroy]



   def index

+    render json: current_bearer.api_keys

   end



   def create

     authenticate_with_http_basic do |email, password|

       user = User.find_by email: email



       if user&amp;.authenticate(password)

         api_key = user.api_keys.create! token: SecureRandom.hex



         render json: api_key, status: :created and return

       end

     end



     render status: :unauthorized

   end



   def destroy

   end

 end

class ApiKeysController &lt; ApplicationController
  include ApiKeyAuthenticatable

  # Require API key authentication for index
  prepend_before_action :authenticate_with_api_key!, only: [:index]

  # Optional API key authentication for logout
  prepend_before_action :authenticate_with_api_key, only: [:destroy]

  def index
    render json: current_bearer.api_keys # [tl! ++]
  end

  def create
    authenticate_with_http_basic do |email, password|
      user = User.find_by email: email

      if user&amp;.authenticate(password)
        api_key = user.api_keys.create! token: SecureRandom.hex

        render json: api_key, status: :created and return
      end
    end

    render status: :unauthorized
  end

  def destroy
  end
end
_content_copy_
</code></pre></div>
<p>Let's try it out:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X GET http://localhost:3000/api-keys \

    -H &#39;Authorization: Bearer 5d1524c7e2486f98e1b65cbe1cdeb258&#39;

# &lt; HTTP/1.1 200 OK

# [

#   {

#     &quot;id&quot;: 1,

#     &quot;bearer_id&quot;: 1,

#     &quot;bearer_type&quot;: &quot;User&quot;,

#     &quot;token&quot;: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;,

#     &quot;created_at&quot;: &quot;2021-04-16T13:56:42.181Z&quot;,

#     &quot;updated_at&quot;: &quot;2021-04-16T13:56:42.181Z&quot;

#   },

#   {

#     &quot;id&quot;: 2,

#     &quot;bearer_id&quot;: 1,

#     &quot;bearer_type&quot;: &quot;User&quot;,

#     &quot;token&quot;: &quot;5d1524c7e2486f98e1b65cbe1cdeb258&quot;,

#     &quot;created_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;,

#     &quot;updated_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;

#   }

# ]

$ curl -v -X GET http://localhost:3000/api-keys \
    -H &#39;Authorization: Bearer 5d1524c7e2486f98e1b65cbe1cdeb258&#39;
# &lt; HTTP/1.1 200 OK
# [
#   {
#     &quot;id&quot;: 1,
#     &quot;bearer_id&quot;: 1,
#     &quot;bearer_type&quot;: &quot;User&quot;,
#     &quot;token&quot;: &quot;5c8e4327fd8b2bf3118f82b13890d89d&quot;,
#     &quot;created_at&quot;: &quot;2021-04-16T13:56:42.181Z&quot;,
#     &quot;updated_at&quot;: &quot;2021-04-16T13:56:42.181Z&quot;
#   },
#   {
#     &quot;id&quot;: 2,
#     &quot;bearer_id&quot;: 1,
#     &quot;bearer_type&quot;: &quot;User&quot;,
#     &quot;token&quot;: &quot;5d1524c7e2486f98e1b65cbe1cdeb258&quot;,
#     &quot;created_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;,
#     &quot;updated_at&quot;: &quot;2021-04-16T15:18:01.709Z&quot;
#   }
# ]
_content_copy_
</code></pre></div>
<p>There they are! Looks good.</p>
<h2 id="revoking-our-first-api-key">Revoking our first API key<a class="headerlink" href="#revoking-our-first-api-key" title="Permanent link">&para;</a></h2>
<p>So we've got our 2 API keys. Let's revoke 1 of them. To do that, we'll need to work on the <code>#destroy</code> action of our controller. It's gonna be as complicated as the last action we wrote, so prepare yourself:</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKeysController &lt; ApplicationController

   include ApiKeyAuthenticatable



   # Require API key authentication for index

   prepend_before_action :authenticate_with_api_key!, only: [:index]



   # Optional API key authentication for logout

   prepend_before_action :authenticate_with_api_key, only: [:destroy]



   def index

     render json: current_bearer.api_keys

   end



   def create

     authenticate_with_http_basic do |email, password|

       user = User.find_by email: email



       if user&amp;.authenticate(password)

         api_key = user.api_keys.create! token: SecureRandom.hex



         render json: api_key, status: :created and return

       end

     end



     render status: :unauthorized

   end



   def destroy

+    current_api_key&amp;.destroy

   end

 end

class ApiKeysController &lt; ApplicationController
  include ApiKeyAuthenticatable

  # Require API key authentication for index
  prepend_before_action :authenticate_with_api_key!, only: [:index]

  # Optional API key authentication for logout
  prepend_before_action :authenticate_with_api_key, only: [:destroy]

  def index
    render json: current_bearer.api_keys
  end

  def create
    authenticate_with_http_basic do |email, password|
      user = User.find_by email: email

      if user&amp;.authenticate(password)
        api_key = user.api_keys.create! token: SecureRandom.hex

        render json: api_key, status: :created and return
      end
    end

    render status: :unauthorized
  end

  def destroy
    current_api_key&amp;.destroy # [tl! ++]
  end
end
_content_copy_
</code></pre></div>
<p>That's all it takes, folks. Now let's test it out by revoking our original API key, the one that we created in the Rails console:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X DELETE http://localhost:3000/api-keys \

    -H &#39;Authorization: Bearer 5c8e4327fd8b2bf3118f82b13890d89d&#39;

# &lt; HTTP/1.1 204 No Content

$ curl -v -X DELETE http://localhost:3000/api-keys \
    -H &#39;Authorization: Bearer 5c8e4327fd8b2bf3118f82b13890d89d&#39;
# &lt; HTTP/1.1 204 No Content
_content_copy_
</code></pre></div>
<p>We got a <code>No Content</code> status code, but did it actually work? Remember, our <code>DELETE</code> endpoint has optional API key authentication, unlike the list endpoint which requires authentication, so even if an invalid API key was provided, it would still return a <code>204 No Content</code> status code. Is this ideal? Probably not, but it works to expemlify the 2 different authentication actions.</p>
<p>Let's assert that the API key was revoked, using the Rails console:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; ApiKey.count

# =&gt; 1

&gt; ApiKey.find_by token: &#39;5c8e4327fd8b2bf3118f82b13890d89d&#39;

# =&gt; nil

$ rails c
&gt; ApiKey.count
# =&gt; 1
&gt; ApiKey.find_by token: &#39;5c8e4327fd8b2bf3118f82b13890d89d&#39;
# =&gt; nil
_content_copy_
</code></pre></div>
<p>Looks like it worked!</p>
<h2 id="to-bear-or-not-to-bear">To bear or not to bear<a class="headerlink" href="#to-bear-or-not-to-bear" title="Permanent link">&para;</a></h2>
<p>Since our API keys are polymorphic, we can have multiple authenticatable models, such as an <code>Admin</code> model, or a <code>SpaceInvader</code>. The sky's the limit, and as long as your code is flexible enough, i.e. it's not expecting a <code>User</code> everywhere a bearer is, you shouldn't have any issues making some obscure model an API key bearer.</p>
<p>Pair this with an authorization gem like Pundit and you'll be golden. I've been running a variant of this for Keygen's API â allowing users, admins, products and licenses to all be authenticatable, each with different permission sets.</p>
<p>(I won't get too deep into the weeds here, but I thought it'd be worth mentioning.)</p>
<h2 id="wrapping-up">Wrapping up<a class="headerlink" href="#wrapping-up" title="Permanent link">&para;</a></h2>
<p>That's it. We've implemented a login endpoint where we can generate new API keys, a logout endpoint where we can revoke existing API keys, as well as an endpoint allowing us to list the current user's API keys. From here, adding API key authentication to other controller actions is as simple as adding one of the 2 <code>before_action</code> callbacks.</p>
<p>Some people may raise concern that we're "rolling our own auth" here, but that's actually not true. We're using tools that Rails provides for us out-of-the-box. API key authentication doesn't have to be complex, and you most certainly don't have to use a third-party gem like Devise to implement it.</p>
<p>Also, you certainly don't need JWTs either. But that's an entire other blog post in and of itself. But I digressâ¦ for another day, for another day.</p>
<p>You can harden your authentication token scheme by utilizing HMAC digests to protect against timing-attacks and to prevent tokens from being stored in plaintext, but I'll leave that as an exercise to the reader. (Edit: I made a mistake not including the HMAC solution in the original post. Please see update below.)</p>
<p>We've manged to do everything here in under 100 lines of code â 96 to be exact â and that's including the migrations! That's pretty cool if you ask me.</p>
<p>Looking for more? Next, <a href="/blog/how-to-implement-totp-2fa-in-rails-using-rotp/">learn how to implement TOTP 2FA using ROTP</a>.</p>
<hr />
<h4 id="update-april-17th-2021">Update: April 17th, 2021<a class="headerlink" href="#update-april-17th-2021" title="Permanent link">&para;</a></h4>
<p>It was brought to my attention shortly after publishing this post that the original code is storing API keys as plaintext in the database, which is true. That fact was (briefly) mentioned at the end of the post, and I originally thought including the solution would complicate the post, but I think I made a mistake excluding it. We should always strive to reflect best security practices when writing technical "how-to" posts, even if that results in more complex code or a longer blog post.</p>
<p>Because the original code stores tokens in plaintext, the code <a href="https://en.wikipedia.org/wiki/Timing_attack">could also be vulnerable to timing attacks</a>. We're going to utilize a secure HMAC function to resolve both of these vulnerabilities.</p>
<p>To sum up, the 2 vulnerabilities are:</p>
<ol>
<li>Storing API keys as plaintext (a big no-no â these tokens should be treated like passwords.)</li>
<li>Tokens could be vulnerable to timing attacks (yes, <a href="https://soatok.blog/2021/08/20/lobste-rs-password-reset-vulnerability/">even with a database index</a>!)</li>
</ol>
<p>I'm leaving the original blog post unchanged for transparency.</p>
<h2 id="patching-the-vulnerabilities">Patching the vulnerabilities<a class="headerlink" href="#patching-the-vulnerabilities" title="Permanent link">&para;</a></h2>
<p>To start our patch, let's rollback our last migration which created the <code>tokens</code> table. We're going to slightly modify the schema. In a production environment, we'd want to add a new column, populate it, and then remove the old column, but this will suffice for our toy example application.</p>
<div class="language-text highlight"><pre><span></span><code>$ rails db:rollback

$ rails db:rollback
_content_copy_
</code></pre></div>
<p>Open up our last migration and change the <code>token</code> column to <code>token_digest</code>:</p>
<div class="language-text highlight"><pre><span></span><code> class CreateApiKeys &lt; ActiveRecord::Migration[5.2]

   def change

     create_table :api_keys do |t|

       t.integer :bearer_id, null: false

       t.string :bearer_type, null: false

-      t.string :token, null: false

+      t.string :token_digest, null: false

       t.timestamps null: false

     end



     add_index :api_keys, [:bearer_id, :bearer_type]

-    add_index :api_keys, :token, unique: true

+    add_index :api_keys, :token_digest, unique: true

   end

 end

class CreateApiKeys &lt; ActiveRecord::Migration[5.2]
  def change
    create_table :api_keys do |t|
      t.integer :bearer_id, null: false
      t.string :bearer_type, null: false
      t.string :token, null: false # [tl! --]
      t.string :token_digest, null: false # [tl! ++]
      t.timestamps null: false
    end

    add_index :api_keys, [:bearer_id, :bearer_type]
    add_index :api_keys, :token, unique: true # [tl! --]
    add_index :api_keys, :token_digest, unique: true # [tl! ++]
  end
end
_content_copy_
</code></pre></div>
<p>Then we'll want to re-run the migration:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails db:migrate

$ rails db:migrate
_content_copy_
</code></pre></div>
<p>Next, we're going to update the <code>ApiKey</code> model to utilize a SHA-256 HMAC function, and also provide a method for authenticating an API key by token.</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKey &lt; ApplicationRecord

+  HMAC_SECRET_KEY = ENV.fetch(&#39;API_KEY_HMAC_SECRET_KEY&#39;)

+

   belongs_to :bearer, polymorphic: true

+

+  before_create :generate_token_hmac_digest

+

+  # Virtual attribute for raw token value, allowing us to respond with the

+  # API key&#39;s non-hashed token value. but only directly after creation.

+  attr_accessor :token

+

+  def self.authenticate_by_token!(token)

+    digest = OpenSSL::HMAC.hexdigest &#39;SHA256&#39;, HMAC_SECRET_KEY, token

+

+    find_by! token_digest: digest

+  end

+

+  def self.authenticate_by_token(token)

+    authenticate_by_token! token

+  rescue ActiveRecord::RecordNotFound

+    nil

+  end

+

+  # Add virtual token attribute to serializable attributes, and exclude

+  # the token&#39;s HMAC digest

+  def serializable_hash(options = nil)

+    h = super options.merge(except: &#39;token_digest&#39;)

+    h.merge! &#39;token&#39; =&gt; token if token.present?

+    h

+  end

+

+  private

+

+  def generate_token_hmac_digest

+    raise ActiveRecord::RecordInvalid, &#39;token is required&#39; unless

+      token.present?

+

+    digest = OpenSSL::HMAC.hexdigest &#39;SHA256&#39;, HMAC_SECRET_KEY, token

+

+    self.token_digest = digest

+  end

 end

class ApiKey &lt; ApplicationRecord
  HMAC_SECRET_KEY = ENV.fetch(&#39;API_KEY_HMAC_SECRET_KEY&#39;) # [tl! ++]
  # [tl! ++]
  belongs_to :bearer, polymorphic: true
  # [tl! ++:start]
  before_create :generate_token_hmac_digest

  # Virtual attribute for raw token value, allowing us to respond with the
  # API key&#39;s non-hashed token value. but only directly after creation.
  attr_accessor :token

  def self.authenticate_by_token!(token)
    digest = OpenSSL::HMAC.hexdigest &#39;SHA256&#39;, HMAC_SECRET_KEY, token

    find_by! token_digest: digest
  end

  def self.authenticate_by_token(token)
    authenticate_by_token! token
  rescue ActiveRecord::RecordNotFound
    nil
  end

  # Add virtual token attribute to serializable attributes, and exclude
  # the token&#39;s HMAC digest
  def serializable_hash(options = nil)
    h = super options.merge(except: &#39;token_digest&#39;)
    h.merge! &#39;token&#39; =&gt; token if token.present?
    h
  end

  private

  def generate_token_hmac_digest
    raise ActiveRecord::RecordInvalid, &#39;token is required&#39; unless
      token.present?

    digest = OpenSSL::HMAC.hexdigest &#39;SHA256&#39;, HMAC_SECRET_KEY, token

    self.token_digest = digest
  end # [tl! ++:end]
end
_content_copy_
</code></pre></div>
<p>Here we've defined a few new methods for the <code>ApiKey</code> model:</p>
<ul>
<li>A new virtual attribute called <code>token</code> which holds the plaintext value of our API key's token. This virtual attribute is only available after the model is created.</li>
<li>Redefining an API key's <code>serializable_hash</code> attributes, to include the <code>token</code> virtual attribute when present, and to always exclude <code>token_digest</code>.</li>
<li>A <code>before_create</code> callback which handles generating an HMAC of the current token before the API key is persisted to the database.</li>
<li>Bang and non-bang variants of <code>authenticate_by_token</code> which handles securely looking up an API key by token.</li>
</ul>
<p>Our HMAC function requires a secret key to be able to compute digests, defined in a new <code>API_KEY_HMAC_SECRET_KEY</code> environment variable. Let's generate a random string with 32 bytes of entropy that we can use for the HMAC secret key:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; SecureRandom.hex(32)

# =&gt; febf2568e5f151dc979ebdb84f05633417beeef06b9fb4e32e6c4eea6b121afc

$ rails c
&gt; SecureRandom.hex(32)
# =&gt; febf2568e5f151dc979ebdb84f05633417beeef06b9fb4e32e6c4eea6b121afc
_content_copy_
</code></pre></div>
<p>And let's go ahead and set the required environment variable:</p>
<div class="language-text highlight"><pre><span></span><code>$ export API_KEY_HMAC_SECRET_KEY=febf2568e5f151dc979ebdb84f05633417beeef06b9fb4e32e6c4eea6b121afc

$ export API_KEY_HMAC_SECRET_KEY=febf2568e5f151dc979ebdb84f05633417beeef06b9fb4e32e6c4eea6b121afc
_content_copy_
</code></pre></div>
<p>Do note that the HMAC secret key should never change. Changing the secret key will invalidate all existing API keys, since we'd no longer be able to authenticate them.</p>
<p>Lastly, we'll want to update the <code>ApiKeyAuthenticatable</code> concern to use our new API key authentication method:</p>
<div class="language-text highlight"><pre><span></span><code> module ApiKeyAuthenticatable

   extend ActiveSupport::Concern



   include ActionController::HttpAuthentication::Basic::ControllerMethods

   include ActionController::HttpAuthentication::Token::ControllerMethods



   attr_reader :current_api_key

   attr_reader :current_bearer



   # Use this to raise an error and automatically respond with a 401 HTTP status

   # code when API key authentication fails

   def authenticate_with_api_key!

     @current_bearer = authenticate_or_request_with_http_token &amp;method(:authenticator)

   end



   # Use this for optional API key authentication

   def authenticate_with_api_key

     @current_bearer = authenticate_with_http_token &amp;method(:authenticator)

   end



   private



   attr_writer :current_api_key

   attr_writer :current_bearer



   def authenticator(http_token, options)

-    @current_api_key = ApiKey.find_by token: http_token

+    @current_api_key = ApiKey.authenticate_by_token http_token



     current_api_key&amp;.bearer

   end

 end

module ApiKeyAuthenticatable
  extend ActiveSupport::Concern

  include ActionController::HttpAuthentication::Basic::ControllerMethods
  include ActionController::HttpAuthentication::Token::ControllerMethods

  attr_reader :current_api_key
  attr_reader :current_bearer

  # Use this to raise an error and automatically respond with a 401 HTTP status
  # code when API key authentication fails
  def authenticate_with_api_key!
    @current_bearer = authenticate_or_request_with_http_token &amp;method(:authenticator)
  end

  # Use this for optional API key authentication
  def authenticate_with_api_key
    @current_bearer = authenticate_with_http_token &amp;method(:authenticator)
  end

  private

  attr_writer :current_api_key
  attr_writer :current_bearer

  def authenticator(http_token, options)
    @current_api_key = ApiKey.find_by token: http_token # [tl! --]
    @current_api_key = ApiKey.authenticate_by_token http_token # [tl! ++]

    current_api_key&amp;.bearer
  end
end
_content_copy_
</code></pre></div>
<h2 id="verifying-our-patch">Verifying our patch<a class="headerlink" href="#verifying-our-patch" title="Permanent link">&para;</a></h2>
<p>First up â let's generate a new API key:</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X POST http://localhost:3000/api-keys \

    -u [[email protected]](/cdn-cgi/l/email-protection):secret

# &lt; HTTP/1.1 201 Created

# {

#   &quot;id&quot;: 3,

#   &quot;bearer_id&quot;: 1,

#   &quot;bearer_type&quot;: &quot;User&quot;,

#   &quot;created_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,

#   &quot;updated_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,

#   &quot;token&quot;: &quot;4ff169e0c3e42fd0b60af4f12abae086&quot;

# }

$ curl -v -X POST http://localhost:3000/api-keys \
    -u zeke@keygen.example:secret
# &lt; HTTP/1.1 201 Created
# {
#   &quot;id&quot;: 3,
#   &quot;bearer_id&quot;: 1,
#   &quot;bearer_type&quot;: &quot;User&quot;,
#   &quot;created_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,
#   &quot;updated_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,
#   &quot;token&quot;: &quot;4ff169e0c3e42fd0b60af4f12abae086&quot;
# }
_content_copy_
</code></pre></div>
<p>Looks good. The API key's token is correctly being generated, and the raw token value is still being serialized in the JSON response. But let's assert that the token is no longer being stored in plaintext:</p>
<div class="language-text highlight"><pre><span></span><code>$ rails c

&gt; ApiKey.last

# =&gt; #&lt;ApiKey id: 3, bearer_id: 1, bearer_type: &quot;User&quot;, token_digest: &quot;f2f00166929739413ebe7848306d4be04b57447ad92a386d27...&quot;, created_at: &quot;2021-04-17 19:44:28&quot;, updated_at: &quot;2021-04-17 19:44:28&quot;&gt;

$ rails c
&gt; ApiKey.last
# =&gt; #&lt;ApiKey id: 3, bearer_id: 1, bearer_type: &quot;User&quot;, token_digest: &quot;f2f00166929739413ebe7848306d4be04b57447ad92a386d27...&quot;, created_at: &quot;2021-04-17 19:44:28&quot;, updated_at: &quot;2021-04-17 19:44:28&quot;&gt;
_content_copy_
</code></pre></div>
<p>Looks correct. Now let's also make sure we can still authenticate with our API key's token, and we also want to assert that we're not leaking our <code>token_digest</code> in the list of serialized API keys.</p>
<div class="language-text highlight"><pre><span></span><code>$ curl -v -X GET http://localhost:3000/api-keys \

    -H &#39;Authorization: Bearer 4ff169e0c3e42fd0b60af4f12abae086&#39;

# &lt; HTTP/1.1 200 OK

# [

#   {

#     &quot;id&quot;: 3,

#     &quot;bearer_id&quot;: 1,

#     &quot;bearer_type&quot;: &quot;User&quot;,

#     &quot;created_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,

#     &quot;updated_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;

#   }

# ]

$ curl -v -X GET http://localhost:3000/api-keys \
    -H &#39;Authorization: Bearer 4ff169e0c3e42fd0b60af4f12abae086&#39;
# &lt; HTTP/1.1 200 OK
# [
#   {
#     &quot;id&quot;: 3,
#     &quot;bearer_id&quot;: 1,
#     &quot;bearer_type&quot;: &quot;User&quot;,
#     &quot;created_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;,
#     &quot;updated_at&quot;: &quot;2021-04-17T19:44:28.975Z&quot;
#   }
# ]
_content_copy_
</code></pre></div>
<p>And once again, things look good. But we have a new problem. Since we can no longer read the tokens of other API keys, we're unable to delete them using our existing API key deletion endpoint. To fix this issue, let's rework our "logout" endpoint.</p>
<p>Let's open up our <code>routes.rb</code> file and make a quick edit (and in the process, we get to make our endpoints more Rails-y with <code>resources</code>):</p>
<div class="language-text highlight"><pre><span></span><code> Rails.application.routes.draw do

-  post &#39;/api-keys&#39;, to: &#39;api_keys#create&#39;

-  delete &#39;/api-keys&#39;, to: &#39;api_keys#destroy&#39;

-  get &#39;/api-keys&#39;, to: &#39;api_keys#index&#39;

+  resources :api_keys, path: &#39;api-keys&#39;, only: %i[index create destroy]

 end

Rails.application.routes.draw do
  post &#39;/api-keys&#39;, to: &#39;api_keys#create&#39; # [tl! --]
  delete &#39;/api-keys&#39;, to: &#39;api_keys#destroy&#39; # [tl! --]
  get &#39;/api-keys&#39;, to: &#39;api_keys#index&#39; # [tl! --]
  resources :api_keys, path: &#39;api-keys&#39;, only: %i[index create destroy] # [tl! ++]
end
_content_copy_
</code></pre></div>
<p>And we'll also want to update our controller to revoke API keys by ID, rather than simply revoking the <code>current_api_key</code>:</p>
<div class="language-text highlight"><pre><span></span><code> class ApiKeysController &lt; ApplicationController

   include ApiKeyAuthenticatable



-  # Require API key authentication for index

-  prepend_before_action :authenticate_with_api_key!, only: [:index]

+  # Require API key authentication

+  prepend_before_action :authenticate_with_api_key!, only: %i[index destroy]

-

-  # Optional API key authentication for logout

-  prepend_before_action :authenticate_with_api_key, only: [:destroy]



   def index

     render json: current_bearer.api_keys

   end



   def create

     authenticate_with_http_basic do |email, password|

       user = User.find_by email: email



       if user&amp;.authenticate(password)

         api_key = user.api_keys.create! token: SecureRandom.hex



         render json: api_key, status: :created and return

       end

     end



     render status: :unauthorized

   end



   def destroy

+    api_key = current_bearer.api_keys.find(params[:id])

+

-    current_api_key&amp;.destroy

+    api_key.destroy

   end

 end

class ApiKeysController &lt; ApplicationController
  include ApiKeyAuthenticatable

  # Require API key authentication for index                                   [tl! --]
  prepend_before_action :authenticate_with_api_key!, only: [:index] # [tl! --]
  # Require API key authentication                                             [tl! ++]
  prepend_before_action :authenticate_with_api_key!, only: %i[index destroy] # [tl! ++]
  # [tl! --]
  # Optional API key authentication for logout                                 [tl! --]
  prepend_before_action :authenticate_with_api_key, only: [:destroy] # [tl! --]

  def index
    render json: current_bearer.api_keys
  end

  def create
    authenticate_with_http_basic do |email, password|
      user = User.find_by email: email

      if user&amp;.authenticate(password)
        api_key = user.api_keys.create! token: SecureRandom.hex

        render json: api_key, status: :created and return
      end
    end

    render status: :unauthorized
  end

  def destroy
    api_key = current_bearer.api_keys.find(params[:id]) # [tl! ++]
    # [tl! ++]
    current_api_key&amp;.destroy # [tl! --]
    api_key.destroy # [tl! ++]
  end
end
_content_copy_
</code></pre></div>
<p>And voila! This patch does add a bit of complexity to the API key model, but it resolves critical vulnerabilities in the original implementation. You can view <a href="https://github.com/ezekg/example-rails-api-key-authentication">the full example app on GitHub</a>.</p>
<p>Thanks to /u/stouset for the report.</p>
<hr />
<p>If you find any errors in my code, or if you can think of ways to improve things, <a href="https://x.com/_m27e">ping me via Twitter</a>. </p>
<p>Â© 2016â2026 Keygen LLC â All Rights Reserved â Reach out &lt;<a href="/cdn-cgi/l/email-protection">[email protected]</a>&gt;<br />
The Keygen name, logo, and mark are trademarks of Keygen LLC in the United States</p>
<ul>
<li><a href="https://status.keygen.sh">Status</a></li>
<li><a href="/about/">About</a></li>
<li><a href="/security/">Security</a></li>
<li><a href="/changelog/">Changelog</a></li>
<li><a href="/privacy/">Privacy</a></li>
<li><a href="/terms/">Terms</a></li>
<li><a href="/terms/sla/">SLA</a></li>
<li><a href="/blog/">Blog</a></li>
<li><a href="/jobs/">Jobs</a></li>
<li><a href="/press/">Press</a></li>
<li><a href="/license/">License</a></li>
<li><a href="/cla/">CLA</a></li>
<li><a href="https://github.com/keygen-sh"> __</a></li>
<li><a href="https://hub.docker.com/u/keygen">__</a></li>
<li><a href="https://discord.gg/TRrhSaWSsN"></a></li>
<li><a href="https://twitter.com/keygen_sh">__</a></li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="2026年2月21日 16:02:40 UTC">2026-02-21</span>
  </span>

    
    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        这篇文章有帮助吗？
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="有帮助" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 9v12H1V9zm4 12a2 2 0 0 1-2-2V9c0-.55.22-1.05.59-1.41L14.17 1l1.06 1.06c.27.27.44.64.44 1.05l-.03.32L14.69 8H21a2 2 0 0 1 2 2v2c0 .26-.05.5-.14.73l-3.02 7.05C19.54 20.5 18.83 21 18 21zm0-2h9.03L21 12v-2h-8.79l1.13-5.32L9 9.03z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="没帮助" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 15V3h4v12zM15 3a2 2 0 0 1 2 2v10c0 .55-.22 1.05-.59 1.41L9.83 23l-1.06-1.06c-.27-.27-.44-.64-.44-1.06l.03-.31.95-4.57H3a2 2 0 0 1-2-2v-2c0-.26.05-.5.14-.73l3.02-7.05C4.46 3.5 5.17 3 6 3zm0 2H5.97L3 12v2h8.78l-1.13 5.32L15 14.97z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              感谢反馈！
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              感谢反馈！我们会改进。
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 - OpenClaw
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
    <a href="https://github.com/mrgolftech" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.action.edit"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>